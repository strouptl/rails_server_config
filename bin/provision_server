#!/bin/bash

echo "Are you provisioning this server for staging or for production (S: staging, P: production)?"

read environment
if [$environment == S]
  environment=staging
elif [$environment == P]
  environment=production
else
  environment=production
fi

# Install Packages

## PostgreSQL Client
sudo apt install postgresql-client -y

## Nginx
sudo apt install nginx -y

## Logrotate
sudo apt install logrotate -y

## Yarn
sudo apt install yarnpkg -y

# Install Ruby
./bin/install_ruby

# Install GeoIpUpdate
./bin/install_geoipupdate

# Install AWS Cloudwatch
./bin/install_aws_cloudwatch

# Prepare Capistrano Directory
sudo mkdir /var/www/rails
sudo chown -R ubuntu:ubuntu /var/www/rails
mkdir /var/www/rails/shared

# Update config files
if [$environment == P]
  ./bin/update_config_files
else
  ./bin/staging/update_config_files
fi

# Enable services
sudo systemctl enable rails
sudo systemctl enable sidekiq

# Reload services (for logrotate)
sudo systemctl daemon-reload
