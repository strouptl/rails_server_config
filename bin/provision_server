#!/bin/bash

echo "Are you provisioning this server for staging or for production (S: staging, P: production)?"

read environment

if [[ $environment == S ]]; then
  environment=staging
elif [[ $environment == P ]]; then
  environment=production
else
  environment=production
fi

if [[ $environment == production ]]; then
  echo "Is this a web server or a worker (web, worker)?"
  read server_type
fi

# Install Packages

## PostgreSQL Client
sudo apt install postgresql-client -y

## Nginx
sudo apt install nginx -y

## Logrotate
sudo apt install logrotate -y

## Yarn
sudo apt install yarnpkg -y

# Install Ruby
./bin/provision_server_scripts/install_ruby

# Install GeoIpUpdate
./bin/provision_server_scripts/install_geoipupdate

# Install AWS Cloudwatch
./bin/provision_server_scripts/install_aws_cloudwatch

# Prepare Capistrano Directory
sudo mkdir /var/www/rails
sudo chown -R ubuntu:ubuntu /var/www/rails
mkdir /var/www/rails/shared

# Self signed certificate
if [[ $environment == P ]]; then
  ./bin/provision_server_scripts/create_self_signed_certificate
fi

# Update config files
if [[ $environment == production ]]; then
  ./bin/provision_server_scripts/update_config_files
else
  ./bin/provision_server_scripts/update_config_files_staging
fi

# Enable services
if [[ $environment == staging ]]; then
  sudo systemctl enable rails
  sudo systemctl enable sidekiq
fi

if [[ $environment == production ]]; then
  if [[ $server_type == web ]]; then
    sudo systemctl enable rails
  elif [[ $server_type == worker ]]; then
    sudo systemctl enable sidekiq
  fi
fi

# Reload services (for logrotate)
sudo systemctl daemon-reload
